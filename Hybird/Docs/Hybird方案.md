# Hybirdæ–¹æ¡ˆ

# è°ƒç ”ç¯‡

![](Untitled-c5734e8c-fd52-42ba-84a1-9e3c0719145c.png)

## Question1ï¼šä»€ä¹ˆæ˜¯Hybirdï¼Ÿ

Hybirdå…¶å®æ˜¯å¯¹æ··åˆåº”ç”¨å¼€å‘æŠ€æœ¯çš„ä¸€ç§ä¿—ç§°ï¼Œæ‰€è°“çš„æ··åˆåº”ç”¨å¼€å‘æŠ€æœ¯æ˜¯æŒ‡èåˆäº†Nativeå’ŒWebçš„å¼€å‘æŠ€æœ¯ï¼ˆNativeæ˜¯æŒ‡å„ä¸ªå¹³å°åŸç”Ÿèƒ½åŠ›ï¼Œæ¯”å¦‚ï¼šAndroidä½¿ç”¨çš„Java/Kotlinè¯­è¨€èƒ½åŠ›ï¼Œè€ŒiOSä½¿ç”¨çš„Objective-Cæˆ–Swiftï¼‰ï¼Œè¿™ç§æŠ€æœ¯çš„è¯ç”Ÿå…¶å®è´¨æ˜¯æ¨¡ç³Šäº†å‰ç«¯å¼€å‘çš„è¾¹ç•Œï¼Œä¹Ÿè®©å‰ç«¯å®ç°äº†åˆ°å¤§å‰ç«¯çš„è·ƒè¿›ã€‚

## Question2ï¼šç›®å‰å¸‚é¢ä¸Šéƒ½æœ‰å“ªäº›Hybirdæ–¹æ¡ˆï¼Ÿ

å…³äºç›®å‰å¸‚é¢ä¸ŠHybirdæ¡†æ¶å…¶é‡ä¸å¯å»æŒ‡ç®—ï¼Œä½†å…¶æŠ€æœ¯æ–¹æ¡ˆä¸»è¦åŸºäºä»¥ä¸‹å‡ ç§ï¼š

1. åŸºäºWebview UIçš„åŸºç¡€æ–¹æ¡ˆã€‚å¸‚é¢ä¸Šä¸»æµï¼Œä¾‹å¦‚å¾®ä¿¡SDKï¼Œé€šè¿‡JsBridgeå®ŒæˆH5å’ŒNativeçš„åŒå‘é€šè®¯ï¼Œä»è€Œèµ‹äºˆH5ä¸€å®šçš„åŸç”Ÿèƒ½åŠ›ã€‚
2. åŸºäºNative UIçš„æ–¹æ¡ˆï¼Œä¾‹å¦‚React-nativeã€Weexç­‰ã€‚åœ¨èµ‹äºˆH5åŸç”ŸAPIèƒ½åŠ›çš„åŸºç¡€ä¸Šï¼Œè¿›ä¸€æ­¥é€šè¿‡JsBridgeå°†jsè§£ææˆè™šæ‹Ÿdomä¼ é€’åˆ°nativeï¼Œå¹¶ä½¿ç”¨åŸç”Ÿæ¸²æŸ“ã€‚
3. å°ç¨‹åºæ–¹æ¡ˆã€‚é€šè¿‡å®šåˆ¶åŒ–çš„JsBridgeï¼Œä½¿ç”¨åŒWebviewå’ŒåŒçº¿ç¨‹çš„æ¨¡å¼éš”ç¦»äº†JSé€»è¾‘å’ŒUIæ¸²æŸ“ï¼Œå½¢æˆç‰¹æ®Šçš„å¼€å‘æ¨¡å¼ï¼ŒåŠ å¼ºäº†H5å’ŒåŸç”Ÿçš„æ··åˆç¨‹åº¦ï¼Œæé«˜äº†é¡µé¢æ€§èƒ½å’Œå¼€å‘ä½“éªŒã€‚

## Hybirdä¼˜åŠ¿

HybirdæŠ€æœ¯å¸¦æ¥çš„ä¼˜åŠ¿æœ‰å¾ˆå¤šï¼Œé€šè¿‡å­¦ä¹ å’Œå®é™…åº”ç”¨ï¼Œæˆ‘æ€»ç»“äº†å¦‚ä¸‹å‡ ç‚¹ï¼š

- å¿«é€Ÿå¼€å‘
- ç»Ÿä¸€äº†äº¤äº’UI
- å€ŸåŠ©äºH5å¼ºå¤§çš„è¡¨ç°èƒ½åŠ›ï¼Œæ˜¯Appè¡¨è¾¾æ›´åŠ ä¸°å¯Œ
- æ— ç­‰å¾…ä¸Šçº¿ ğŸ‘

## æŠ€æœ¯æ–¹æ¡ˆ

æœ¬ç¯‡è®¨è®ºçš„èŒƒç•´é™äºä¸Šé¢ä»‹ç»çš„ç¬¬ä¸€ç§æŠ€æœ¯æ–¹æ¡ˆï¼Œå³é€šè¿‡JsBridgeå®ŒæˆH5å’ŒNativeçš„åŒå‘é€šè®¯ï¼Œä¸‹é¢å°±Androidå’ŒiOSå¹³å°åˆ†åˆ«è¯´æ˜ã€‚

### Android

- **Nativeè°ƒç”¨H5**

åœ¨Androidä¸­Nativeè°ƒç”¨H5ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š

- `webView.loadUrl("javascript: alert( 'hello world' )");`
- `webView.evaluateJavascript(String script, @RecentlyNullable ValueCallback<String> resultCallback);`

ç¬¬ä¸€ç§æ˜¯é’ˆå¯¹æ²¡æœ‰è¿”å›å€¼æƒ…å†µçš„ï¼Œç¬¬äºŒç§å¯ä»¥æ¥å—è¿”å›å€¼ã€‚

- **H5è°ƒç”¨Native**

å³JSè°ƒNativeï¼Œåœ¨Androidç«¯æœ‰URLæ‹¦æˆªå¤„ç†ã€Alertæ‹¦æˆªã€JSä¸Šä¸‹æ–‡æ³¨å…¥ã€‚

**é¦–å…ˆï¼ŒURLæ‹¦æˆªå¤„ç†**

URLæ‹¦æˆªå¤„ç†æ˜¯æŒ‡JSå°†è¦å’ŒJavaé€šè®¯çš„å†…å®¹åŒ…è£…æˆURLï¼ŒAndroidç«¯é‡è½½`shouldOverrideUrlLoading()`æ–¹æ³•ï¼Œæ¥å¤„ç†JSè¯·æ±‚ï¼Œä¾‹å¦‚ï¼š

    <a href="msg://modleName/actionMethod?params=123...">å‘é€æ¶ˆæ¯<a>

åœ¨Androidä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¤„ç†è¯¥æ¶ˆæ¯

    @Override
    public boolean shouldOverrideUrlLoading(WebView view, String url) {
        //1 æ ¹æ®urlï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯æ‰€éœ€è¦çš„æ‹¦æˆªçš„è°ƒç”¨ ä¾‹å¦‚ï¼šmsg
        if (æ˜¯){
          //2 å–å‡ºè·¯å¾„ï¼Œç¡®è®¤è¦å‘èµ·çš„nativeè°ƒç”¨çš„æŒ‡ä»¤æ˜¯ä»€ä¹ˆ
          //3 å–å‡ºå‚æ•°ï¼Œæ‹¿åˆ°JSä¼ è¿‡æ¥çš„æ•°æ®
          //4 æ ¹æ®æŒ‡ä»¤è°ƒç”¨å¯¹åº”çš„nativeæ–¹æ³•ï¼Œä¼ é€’æ•°æ®
          return true;
        }
        return super.shouldOverrideUrlLoading(view, url);
    }

å¯ä»¥çœ‹åˆ°ï¼Œè¿™ç§æ–¹å¼æ•´ä½“å®ç°èµ·æ¥ä¹Ÿæ¯”è¾ƒä¼˜é›…ï¼Œä¹Ÿä¾¿äºè®¾è®¡åè®®ï¼Œä½†æ˜¯è¿™ä¸ªæ–¹å¼æœ‰ä¸ªè‡´å‘½çš„ç¼ºé™·ï¼Œé‚£å°±æ˜¯ä¸¢æ¶ˆæ¯ã€‚

**å†çœ‹ï¼ŒAlertæ‹¦æˆª**

Androidå¯ä»¥æ‹¦æˆªJSçš„ä¸‰ç§Alertï¼Œå³

- `alert()`å¼¹å‡ºä¸ªæç¤ºæ¡†ï¼Œåªèƒ½ç‚¹ç¡®è®¤æ— å›è°ƒ
- `confirm()`å¼¹å‡ºä¸ªç¡®è®¤æ¡†ï¼ˆç¡®è®¤ï¼Œå–æ¶ˆï¼‰ï¼Œå¯ä»¥å›è°ƒ
- `prompt()`å¼¹å‡ºä¸ªè¾“å…¥æ¡†ï¼Œè®©ç”¨æˆ·è¾“å…¥ä¸œè¥¿ï¼Œå¯ä»¥å›è°ƒ

è¿™äº›å¼¹æ¡†éƒ½å¯ä»¥ä¼ é€’ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè€Œè¿™å­—ç¬¦å°±å¯ä»¥è¢«ç”¨æ¥è®¾è®¡æˆ‘ä»¬çš„æ¶ˆæ¯ã€‚è¿™é‡Œï¼Œæˆ‘åªç¤ºä¾‹promptè¿™ä¸€ä¸ªæ–¹å¼ï¼Œå…¶ä»–æƒ…å†µç±»ä¼¼å“ˆã€‚

    <html>
    <script type="text/javascript">
    		function promptTest() {
    				var msgBody = {};//å®šä¹‰ä¸€ä¸ªmsgBodyå¯¹è±¡
    				msgBody.handler = 'common';
    		    msgBody.action = 'nativeLog';
    	      msgBody.params = "massage content";
    				var str = sendMessage(msgBody);
    				window.alert(str);
    		}
    </script>
    
    <body>
    <center><p>JSè°ƒNative</p></center>
    <center><p onclick="promptTest()">prompt</p></center>
    </body>
    </html>

ä¸Šé¢å°±æ˜¯æˆ‘ä»¬htmléƒ¨åˆ†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•åœ¨javaä¸­å¤„ç†æ¶ˆæ¯ã€‚

    wv_web.setWebChromeClient(new WebChromeClient() {
    @Override
    public boolean onJsAlert(WebView view, String url, String message, JsResult result) {
    
        return super.onJsAlert(view, url, message, result);
    }
    
    @Override
    public boolean onJsPrompt(WebView view, String url, String message, String defaultValue, JsPromptResult result) {
    		try {
    
    					//è¿™é‡Œå¤„ç†çš„é€»è¾‘æ˜¯ï¼šå…ˆå°†messageè§£æï¼Œè·çš„actionï¼Œå†åˆ¤æ–­æ˜¯å¦æ‹¦æˆªè¯¥å¼¹æ¡†
    					SONArray jsonArray = new JSONArray(message);
    					SONObject jObject = jsonArray.getJSONObject(0);
    
    					if (jObject.has("action")) {
    							String params = jObject.getString("params");
    							Log.d("MainActivity", params);
                  result.confirm(params);
                  return true;
                        }
                    } catch (JSONException e) {
                        e.printStackTrace();
                    }
    
                    return super.onJsPrompt(view, url, message, defaultValue, result);
        }
    });

**æœ€åï¼Œæˆ‘ä»¬æ¥çœ‹JSä¸Šä¸‹æ–‡æ³¨å…¥**

ç§»æ­¥å®è·µç¯‡

è‡³æ­¤ï¼Œå’±ä»¬Androidç«¯å°±ä»‹ç»åˆ°è¿™é‡Œã€‚

### iOS

- **Nativeè°ƒç”¨H5**
    - loadUrl æµè§ˆå™¨ç”¨â€™javascript:â€™+JSä»£ç åšè·³è½¬åœ°å€ï¼ŒWKWebViewå®˜æ–¹æä¾›äº†ä¸€ä¸ªApiï¼Œå¯ä»¥è®©WebViewåœ¨åŠ è½½é¡µé¢çš„æ—¶å€™ï¼Œè‡ªåŠ¨æ‰§è¡Œæ³¨å…¥ä¸€äº›é¢„å…ˆå‡†å¤‡å¥½çš„JS
    - ä½¿ç”¨WKWebViewçš„`evaluateJavascript`æ–¹æ³•ï¼ŒåŠ è½½æ—¶æœºå¯é€‰æ‹©`WKUserScriptInjectionTimeAtDocumentStart`æˆ–è€…`WKUSerScriptInjectionTimeAtDocumentEnd`
- **H5è°ƒç”¨Native**

åŒAndroidä¸€æ ·ï¼ŒiOSè°ƒç”¨JSä¹Ÿæœ‰ä¸‰ç§æ–¹å¼ã€‚

**ç¬¬ä¸€ç§ï¼Œå‡URLè·³è½¬æ‹¦æˆªã€‚**

URLæ„é€ æ–¹å¼åŒAndroidä¸€æ ·ï¼Œè¿™é‡Œå°±ä¸å†è¿‡å¤šèµ˜è¿°äº†ã€‚

iOSçš„UIWebViewçš„æ‹¦æˆªæ–¹å¼ webView:shouldStartLoadWithRequest:navigationType:

    - (BOOL)webView:(UIWebView *)webView shouldStartLoadWithRequest:(NSURLRequest *)request navigationType:(UIWebViewNavigationType)navigationType
    {
        //1 æ ¹æ®urlï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯æ‰€éœ€è¦çš„æ‹¦æˆªçš„è°ƒç”¨ åˆ¤æ–­åè®®/åŸŸå
        if (æ˜¯){
          //2 å–å‡ºè·¯å¾„ï¼Œç¡®è®¤è¦å‘èµ·çš„nativeè°ƒç”¨çš„æŒ‡ä»¤æ˜¯ä»€ä¹ˆ
          //3 å–å‡ºå‚æ•°ï¼Œæ‹¿åˆ°JSä¼ è¿‡æ¥çš„æ•°æ®
          //4 æ ¹æ®æŒ‡ä»¤è°ƒç”¨å¯¹åº”çš„nativeæ–¹æ³•ï¼Œä¼ é€’æ•°æ®
          return NO;
          //ç¡®è®¤æ‹¦æˆªï¼Œæ‹’ç»WebViewç»§ç»­å‘èµ·è¯·æ±‚
        }    
        return YES;
    }

iOSçš„WKWebViewçš„æ‹¦æˆªæ–¹å¼ webView:decidePolicyForNavigationAction:decisionHandler:

    - (void)webView:(WKWebView *)webView decidePolicyForNavigationAction:(WKNavigationAction *)navigationAction decisionHandler:(void (^)(WKNavigationActionPolicy))decisionHandler {
        //1 æ ¹æ®urlï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯æ‰€éœ€è¦çš„æ‹¦æˆªçš„è°ƒç”¨ åˆ¤æ–­åè®®/åŸŸå
        if (æ˜¯){
          //2 å–å‡ºè·¯å¾„ï¼Œç¡®è®¤è¦å‘èµ·çš„nativeè°ƒç”¨çš„æŒ‡ä»¤æ˜¯ä»€ä¹ˆ
          //3 å–å‡ºå‚æ•°ï¼Œæ‹¿åˆ°JSä¼ è¿‡æ¥çš„æ•°æ®
          //4 æ ¹æ®æŒ‡ä»¤è°ƒç”¨å¯¹åº”çš„nativeæ–¹æ³•ï¼Œä¼ é€’æ•°æ®
          //ç¡®è®¤æ‹¦æˆªï¼Œæ‹’ç»WebViewç»§ç»­å‘èµ·è¯·æ±‚
            decisionHandler(WKNavigationActionPolicyCancel);
        }else{
            decisionHandler(WKNavigationActionPolicyAllow);
        }
        return YES;
    }

**ç¬¬äºŒç§ï¼Œå¼¹æ¡†æ‹¦æˆª**

åŒAndroidä¸€æ ·ï¼Œä¸‰ç§æ–¹å¼æˆ‘åªä»‹ç»ä¸€ç§ï¼š

    //WKWebView webView:runJavaScriptTextInputPanelWithPrompt:...
    - (void)webView:(WKWebView *)webView runJavaScriptTextInputPanelWithPrompt:(NSString *)prompt defaultText:(nullable NSString *)defaultText initiatedByFrame:(WKFrameInfo *)frame completionHandler:(void (^)(NSString * _Nullable result))completionHandler{
        //1 æ ¹æ®ä¼ æ¥çš„å­—ç¬¦ä¸²åè§£å‡ºæ•°æ®ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯æ‰€éœ€è¦çš„æ‹¦æˆªè€Œéå¸¸è§„H5å¼¹æ¡†
        if (æ˜¯){
            //2 å–å‡ºæŒ‡ä»¤å‚æ•°ï¼Œç¡®è®¤è¦å‘èµ·çš„nativeè°ƒç”¨çš„æŒ‡ä»¤æ˜¯ä»€ä¹ˆ
            //3 å–å‡ºæ•°æ®å‚æ•°ï¼Œæ‹¿åˆ°JSä¼ è¿‡æ¥çš„æ•°æ®
            //4 æ ¹æ®æŒ‡ä»¤è°ƒç”¨å¯¹åº”çš„nativeæ–¹æ³•ï¼Œä¼ é€’æ•°æ®
            //ç›´æ¥è¿”å›JSç©ºå­—ç¬¦ä¸²
            completionHandler(@"");
        }else{
            //ç›´æ¥è¿”å›JSç©ºå­—ç¬¦ä¸²
            completionHandler(@"");
        }
    }

**ç¬¬ä¸‰ç§ï¼ŒJSä¸Šä¸‹æ–‡æ³¨å…¥**

- UIWebview JavaScriptCoreæ³¨å…¥

UIWebViewå¯ä»¥é€šè¿‡KVCçš„æ–¹æ³•ï¼Œç›´æ¥æ‹¿åˆ°æ•´ä¸ªWebViewå½“å‰æ‰€æ‹¥æœ‰çš„JSä¸Šä¸‹æ–‡ã€‚

    documentView.webView.mainFrame.javaScriptContext

æ‹¿åˆ°äº†JSContextï¼Œä¸€åˆ‡çš„ä½¿ç”¨æ–¹å¼å°±å’Œç›´æ¥æ“ä½œJavaScriptCoreæ²¡å•¥åŒºåˆ«äº†ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠä»»ä½•éµå¾ªJSExportåè®®çš„å¯¹è±¡ç›´æ¥æ³¨å…¥JSï¼Œè®©JSèƒ½å¤Ÿç›´æ¥æ§åˆ¶å’Œæ“ä½œã€‚

å…·ä½“ï¼Œç•¥ã€‚

## å¦‚ä½•é€‰æ‹©ï¼Ÿ

![](2019-05-14-11-09-14-6fa9b855-ac3c-4358-9f15-e86b634abb98.png)

# å®è·µç¯‡

## æ»¡è¶³Hybirdå¼€å‘ï¼ŒWebViewåº”å…·å¤‡çš„åŸºç¡€åŠŸèƒ½

- è‰¯å¥½çš„JSä¸åŸç”Ÿé€šè®¯äº¤äº’èƒ½åŠ›
- çµæ´»çš„ä¸šåŠ¡æ¨¡å—æ‰©å±•èƒ½åŠ›
- Cookieç®¡ç†
- æœ¬åœ°åŠ è½½JSç®¡ç†

## é€šè®¯äº¤äº’èƒ½åŠ›

- JSä¸»åŠ¨è°ƒç”¨åŸç”Ÿ
- JSä¸»åŠ¨è°ƒç”¨åŸç”Ÿåå›è°ƒ
- åŸç”Ÿä¸»åŠ¨è°ƒç”¨JS
- åŸç”Ÿä¸»åŠ¨è°ƒç”¨JSåå›è°ƒ
- åŒæ­¥é€šè®¯
- é€šè®¯ç¼–ç 
- JSæ¡†æ¶åº”è¯¥å…·å¤‡å¤„ç†nativeä¾§ç”Ÿå‘½å‘¨æœŸçš„èƒ½åŠ›ã€‚æ¯”å¦‚ï¼šAppåˆ‡æ¢åˆ°å‰å°ã€‚ã€å…·ä½“çš„ä¸šåŠ¡å¤„ç†ï¼ŒJSæ¡†æ¶å±‚å¯ä»¥äº¤ç»™JSä¸šåŠ¡å¼€å‘å¤„ç†å³å¯ï¼Œå°±åƒnativeå¼€å‘ä¸­çš„ç”Ÿå‘½å‘¨æœŸæ¨¡æ¿æ–¹æ³•ä¸€æ ·ã€‘

ä»¥ä¸Šå°±æ˜¯å¯¹æˆ‘ä»¬çš„Hybirdæ¡†æ¶çš„åŸºæœ¬æœŸæœ›ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å®ç°å§ã€‚å¤‡æ³¨ï¼šæœ¬æ¬¡æ¡ˆä¾‹æˆ‘ä»¬ä»¥Androidå®ç°æ¥åšåˆ†æï¼ŒiOSå®ç°éƒ¨åˆ†è¯·å‚è€ƒ[ã€Œæ¡ˆä¾‹ã€](http://awhisper.github.io/2018/03/06/hybrid-webcontainer/)ã€‚

### é€šè®¯åè®®

å¥½äº†ï¼Œè¯¥ä»‹ç»çš„åŸºæœ¬æƒ…å†µä¹Ÿä»‹ç»å®Œæ¯•äº†ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å…·ä½“å¦‚ä½•å®ç°å§ï¼Bybirdæ¡†æ¶ä¸­æœ€é‡è¦çš„å°±æ˜¯åŸç”Ÿä¸webä¹‹é—´çš„é€šè®¯ï¼Œè¦é€šè®¯æˆ‘ä»¬å°±å¾—åˆ¶è®¢é€šè®¯åè®®ï¼Œä¸ºäº†ä¿è¯åŸºæœ¬çš„ä¸šåŠ¡èƒ½åŠ›å’Œå¯æ‰©å±•æ€§ï¼Œæˆ‘ä»¬çš„åè®®ä¸ä»…è¦èƒ½è¡¨è¾¾ç›¸åº”çš„ä¸šåŠ¡äº‹ä»¶ï¼Œè€Œä¸”è¿˜éœ€è¦èƒ½å¤Ÿå®ç°éä¸šåŠ¡äº‹ä»¶ï¼Œå…·ä½“åè®®å¦‚ä¸‹ï¼š

    public class Message {
        public String handler;//å®šä¹‰nativeå±‚å¯¹å¤–çš„æ–¹æ³•è°ƒç”¨ç±»
        public String action;//ç›¸åº”çš„nativeæ–¹æ³•
        public String params;//å‚æ•°ä¼ é€’
        public String callbackId;//ç”¨äºæ ‡è¯†JSå›è°ƒå‡½æ•°çš„id
        public String callbackFunction;//ç”¨äºåˆ†å‘å¤„ç†jså›è°ƒå‡½æ•°
    }

åè®®ç±»ä¸­å…·ä½“å­—æ®µçš„å«ä¹‰æˆ‘å·²åœ¨ä»£ç ä¸­æ³¨æ˜ï¼Œè¿™é‡Œå°±ä¸å†èµ˜è¿°äº†ã€‚å¥½äº†åè®®ç±»æˆ‘ä»¬æœ‰äº†ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•å®ç°é€šè®¯éƒ¨åˆ†å‘¢ï¼Ÿ

### JSè°ƒç”¨Native

æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹JSè°ƒç”¨Nativeå±‚ï¼Œå‰é¢è°ƒç ”ç¯‡æˆ‘ä»¬å·²ç»è®²åˆ°è¦å®ç°JSè°ƒç”¨Nativeï¼Œæˆ‘ä»¬æœ‰ä¸‰ç§æ–¹æ¡ˆï¼ˆå…·ä½“æ–¹æ¡ˆå‚è€ƒä¸Šéƒ¨åˆ†ï¼‰ï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©JSä¸Šä¸‹æ–‡æ³¨å…¥çš„æ–¹å¼ï¼Œä¸ºä»€ä¹ˆä¼šé€‰æ‹©è¿™ç§æ–¹æ¡ˆå‘¢ï¼Ÿä»å®ç°åŠŸèƒ½çš„è§’åº¦æ¥è®²é™¤äº†URLæ‹¦æˆªï¼Œalertæ‹¦æˆªå’ŒJSæ³¨å…¥éƒ½å¯ä»¥æ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚ï¼Œä½†æ˜¯ä»æ¡†æ¶è®¾è®¡çš„è§’åº¦æ¥è®²ï¼Œä¸ºäº†è®¾è®¡çš„ä¼˜é›…å’Œæ¡†æ¶ç»“æ„ä¸Šæ¥çœ‹ï¼ŒJSæ³¨å…¥è¦ç›¸å¯¹ä¼˜é›…äº›ï¼Œå¤§å®¶å¯ä»¥å¯¹ç…§ç€ä¹‹å‰æ¥å¯¹æ¯”ä¸‹é¢çš„å®ç°å°±çŸ¥é“äº†ã€‚å¥½äº†ï¼Œé—²è¯å°‘å™ï¼Œæˆ‘ä»¬å…ˆçœ‹JSéƒ¨åˆ†ã€‚

    <html>
    <head>
        <script type="text/javascript" src="./bridge.js"></script>
        <style>
    .button {
        background-color: #4CAF50; /* Green */
        border: none;
        color: white;
        padding: 60px 80px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 40px;
        margin: 4px 2px;
        cursor: pointer;
    }
    
    .button1 {
        box-shadow: 0 8px 16px 0 rgba(0,0,0,0.2), 0 6px 20px 0 rgba(0,0,0,0.19);
        border-radius: 12px;
    }
    </style>
    </head>
    <body>
    <center><button onclick="sendSyncNormalMessage()" class="button button1">[sync]JSè°ƒåŸç”Ÿæ— å›è°ƒ</button></center>
    <center><button onclick="sendSyncCallbackMessage()" class="button button1">[sync]JSè°ƒåŸç”Ÿå›è°ƒ</button></center>
    <center><button onclick="sendAsyncNormalMessage()" class="button button1">[async]JSè°ƒåŸç”Ÿæ— å›è°ƒ</button></center>
    <center><button onclick="sendAsyncCallbackMessage()" class="button button1">[async]JSè°ƒåŸç”Ÿå›è°ƒ</button></center>
    </body>
    </html>

UIæ ·å¼å°±è¿™ä¸ªæ ·å­ï¼š

![](Untitled-29a415b3-1712-4ea5-b581-cfb83b6817bc.png)

è¿™ä¸ªHtml5é¡µé¢éå¸¸ç®€å•ï¼Œå°±4ä¸ªæŒ‰é’®åˆ†åˆ«æè¿°äº†æœ¬æ¡†æ¶çš„æ ¸å¿ƒåŠŸèƒ½ï¼ŒJSè°ƒç”¨Nativeéƒ¨åˆ†åŸºæœ¬è¦†ç›–ï¼Œå¯¹åº”çš„JSè„šæœ¬å¦‚ä¸‹ï¼š

    var msgCallbackMap = [];//å®šä¸€ä¸ªäº†ä¸€ä¸ªmapå¯¹è±¡ï¼Œç”¨æ¥å­˜å‚¨å›è°ƒå‡½æ•°
    //è¯¥å‡½æ•°ç”¨æ¥åˆ†å‘å›è°ƒå¤„ç†
    function callbackDispatcher(callbackId,params){
        var handler = this.msgCallbackMap[callbackId];
        if(handler && typeof(handler) === 'function'){
            console.log(params);
            var resultObj = params ? JSON.parse(params) : {};
            handler(resultObj);
        }
        delete this.msgCallbackMap[callbackId];
    }
    
    //è·å–ç³»ç»Ÿç±»å‹
    function getOS(){
        var u = navigator.userAgent;
    //    var isAndroid = u.indexOf('Android') > -1 || u.indexOf('Adr') > -1; //androidç»ˆç«¯
    //    var isiOS = !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/); //iosç»ˆç«¯
        if(u.indexOf('Android') > -1 || u.indexOf('Adr') > -1){
            return 'Android';
        }else if(!!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/)){
            return 'iOS';
        }else {
            return 'iOS';
        }
    }
    //å‘é€åŒæ­¥æ¶ˆæ¯
    function sendSyncMessage(data){
        if(getOS()=='Android'){
            return window.android.handleSyncMessage(JSON.stringify(data));
        }else{
            //ios
           window.webkit.messageHandlers.BTJSBridge.postMessage(data);
        }
    
    }
    //å‘é€å¼‚æ­¥æ¶ˆæ¯
    function sendAsyncMessage(data){
        if(getOS()=='Android'){
            return window.android.handleAsyncMessage(JSON.stringify(data));
        }else{
            //ios
            window.webkit.messageHandlers.BTJSBridge.postMessage(data);
        }
    }
    //ç”¨äºç”Ÿæˆå›è°ƒå‡½æ•°çš„id
    function getCallbackId(){
        var timestamp = Date.parse(new Date());
        timestamp = timestamp / 1000;
        return timestamp;
    }
    //è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•å‡½æ•°ï¼Œç”¨æ¥æµ‹è¯•å›è°ƒç”¨çš„ï¼Œåœ¨å…·ä½“ä½¿ç”¨åœºæ™¯ä¸­åº”æ›¿æ¢æˆç›¸åº”çš„å‡½æ•°
    function testCallback(params){
        window.alert('nativeå›è°ƒè¿”å›ï¼š'+ params);
    }
    //å‘é€åŒæ­¥æ— å›è°ƒæ¶ˆæ¯
    function sendSyncNormalMessage(){
        var msgBody = {};
        msgBody.handler = 'Common';
        msgBody.action = 'nativeLog';
        msgBody.params = "massage content";
    
        window.alert(sendSyncMessage(msgBody));
    }
    
    //å‘é€åŒæ­¥å›è°ƒæ¶ˆæ¯
    function sendSyncCallbackMessage(){
        var msgBody = {};
        msgBody.handler = 'Core';
        msgBody.action = 'getUserID';
        msgBody.params = "";
        var callbackId = getCallbackId();
        this.msgCallbackMap[callbackId] = testCallback;
        msgBody.callbackId = callbackId;
        msgBody.callbackFunction = 'callbackDispatcher';
        sendSyncMessage(msgBody);
    }
    //å‘é€å¼‚æ­¥æ— å›è°ƒæ¶ˆæ¯
    function sendAsyncNormalMessage(){
        var msgBody = {};
        msgBody.handler = 'Common';
        msgBody.action = 'nativeLog';
        msgBody.params = "massage content";
        sendAsyncMessage(msgBody);
    }
    //å‘é€å¼‚æ­¥æœ‰å›è°ƒæ¶ˆæ¯
    function sendAsyncCallbackMessage(){
        var msgBody = {};
        msgBody.handler = 'Core';
        msgBody.action = 'getUserID';
        msgBody.params = "";
        var callbackId = getCallbackId();
        this.msgCallbackMap[callbackId] = testCallback;
        msgBody.callbackId = callbackId;
        msgBody.callbackFunction = 'callbackDispatcher';
        sendAsyncMessage(msgBody);
    }

å…³äºä¸Šé¢çš„JSè„šæœ¬ï¼Œè¿™é‡Œéœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œç”±äºå’±ä»¬è¿™æ˜¯æ¼”ç¤ºæ¡ˆä¾‹ï¼Œé€šè®¯å¯¹è±¡çš„åˆ›å»ºåœ¨å‡½æ•°ä¸­å¤„ç†çš„ï¼Œä½†åœ¨çœŸå®ä½¿ç”¨åœºæ™¯ä¸­åº”è¯¥å°†æ¶ˆæ¯å¯¹è±¡çš„åˆ›å»ºåŒ…è£…èµ·æ¥ï¼Œæ¶ˆæ¯çš„åˆ›å»ºåº”è¯¥åŒ…å«æ¡†æ¶sdkä¸­ï¼Œä¸åº”è¯¥å°†è¿™ä¹ˆæ ¸å¿ƒçš„å¯¹è±¡æš´éœ²ç»™ç”¨æˆ·ï¼Œè¿™æ˜¯é¢å‘å¯¹è±¡è®¾è®¡çš„åŸåˆ™ã€‚ä»ä¸Šé¢çš„JSè„šæœ¬ä¸­æˆ‘ä»¬å¯çœ‹åˆ°æˆ‘ä»¬åè®®å¯¹è±¡è®¾è®¡çš„é‡è¦æ€§äº†ï¼Œå®ƒçš„è¡¨è¾¾èƒ½åŠ›å°±æ˜¯æˆ‘ä»¬åŠŸèƒ½è®¾è®¡çš„è¾¹ç•Œï¼Œå››ç§åœºæ™¯åŸºæœ¬æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚äº†ï¼Œä»¥ååŸºäºä¸šåŠ¡æ‰©å±•ä¹ŸåŸºæœ¬æ²¡æœ‰é—®é¢˜çš„ã€‚

ä¸Šé¢å°±æ˜¯æˆ‘ä»¬çš„webéƒ¨åˆ†äº†ï¼Œä¸‹é¢æˆ‘æ¥çœ‹çœ‹åœ¨æˆ‘ä»¬Androidç«¯æ˜¯å¦‚ä½•è®¾è®¡ï¼Œå¹¶å®ŒæˆJSä¸å®ƒé€šè®¯çš„å‘¢ï¼Ÿ

![](Untitled-5d4c5800-871c-4564-a6b4-6fe33a679af1.png)

æˆ‘ä»¬çœ‹åˆ°è¿™ä¸ªç»“æ„è¿˜æ˜¯éå¸¸ç®€å•çš„ã€‚funåŒ…ä¸‹å°±æ˜¯æˆ‘ä»¬å¯¹å¤–æä¾›çš„apiï¼ŒCommonè¡¨ç¤ºä¸€äº›åŸºç¡€çš„åŠŸèƒ½ï¼›Coreæä¾›äº†ä¸ä¸šåŠ¡ç›¸å…³çš„æ“ä½œï¼›Sysç”¨äºå°è£…ä¸€äº›ä¸ç³»ç»Ÿç›¸å…³æ“ä½œçš„apiã€‚è¿™ä¸ªè®¾è®¡æ˜¯å¾ˆçµæ´»çš„ï¼Œå®é™…ä½¿ç”¨ä¸­ä¸ä¸€å®šæŒ‰ç…§è¿™æ ·ï¼Œæ ¹æ®å…·ä½“ä¸šåŠ¡è€Œå®šã€‚utilsåŒ…ä¸­æ˜¯ä¸€äº›ç”¨åˆ°çš„å·¥å…·æ–¹æ³•ï¼Œç”±äºç¯‡å¹…é—®é¢˜è¿™é‡Œä¸å†ç»†è¯´äº†ã€‚å‰©ä¸‹çš„è¿™ä¸ªå‡ ä¸ªç±»ä¸­JavaScriptInterfaceå°±æ˜¯æˆ‘ä»¬è¿™ä¸ªæ ¸å¿ƒå®ç°äº†ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å§ã€‚

    		//å¤„ç†åŒæ­¥æ¶ˆæ¯
    		@JavascriptInterface
        public String handleSyncMessage(String params) {
            Log.i(TAG, "handleMessage æ˜¯å¦å‘ç”Ÿåœ¨ä¸»çº¿ç¨‹ï¼š" + (Looper.myLooper() == Looper.getMainLooper()));
            return executeMethod(params);
        }
    
        @JavascriptInterface
        public void handleAsyncMessage(String params) {
    				//ä½¿ç”¨AsyncTaskå¤„ç†å¼‚æ­¥æ¶ˆæ¯
            new AsyncTask<String,Integer,String>(){
    
                @Override
                protected String doInBackground(String[] objects) {
                    try {
                        Thread.sleep(3_000);
                    } catch (InterruptedException e) {
                        e.printStackTrace();
                    }
                    Log.i(TAG, "handleMessage æ˜¯å¦å‘ç”Ÿåœ¨ä¸»çº¿ç¨‹ï¼š" + (Looper.myLooper() == Looper.getMainLooper()));
                    return executeMethod(objects[0]);
                }
            }.execute(params);
        }
    		//å®é™…å¤„ç†æ¶ˆæ¯çš„æ–¹æ³•
        private String executeMethod(String params){
            try {
                Log.d("JavaScriptInterface",params);
                Message msg = GsonUtil.fromJsonToModel(params,Message.class);
                if (msg.isCallbackMessage()){
                    return handleCallbackMessage(msg);
                }else {
                    return  handleNormalMessage(msg);
                }
    
            } catch (Exception e) {
                e.printStackTrace();
                return e.getMessage();
            }
        }
    		
    		//invokeå‡½æ•°ï¼šæ‰§è¡Œç›¸åº”çš„æ–¹æ³•
        @Override
        private String handleNormalMessage(Message msg) {
            try {
                return NativeInvokeHandler.invoke(msg).toString();
            } catch (Exception e) {
                e.printStackTrace();
                return e.getMessage();
            }
        }
    		
    		//
        @Override
        private String handleCallbackMessage(Message msg) {
            try {
                if (!TextUtils.isEmpty(msg.callbackId) && !TextUtils.isEmpty(msg.callbackFunction)) {
                    String call = "javascript:" + msg.callbackFunction + "(" + msg.callbackId + "," + System.currentTimeMillis() + ")";//JSæ­¤æ–¹æ³•çš„è¿”å›å€¼ä¼šé€šè¿‡onReceiveValueå›è°ƒåˆ°åŸç”Ÿ
                    new Handler(Looper.getMainLooper()).post(() -> webView.evaluateJavascript(call, value -> {
                        Log.i(TAG, "ValueCallback æ˜¯å¦å‘ç”Ÿåœ¨ä¸»çº¿ç¨‹ï¼š" + (Looper.myLooper() == Looper.getMainLooper()));//true
                        Toast.makeText(context, "JSæ–¹æ³•è¿”å›" + value, Toast.LENGTH_SHORT).show();
                    }));
                }
                return NativeInvokeHandler.invoke(msg).toString();
            } catch (Exception e) {
                e.printStackTrace();
                return e.getMessage();
            }
        }

è¯¥ç±»ä¸­å¯¹å¤–å…¬å¼€çš„ä¸¤ä¸ªæ–¹æ³•ï¼ˆ`public String handleSyncMessage(String params)` å’Œ`public void handleAsyncMessage(String params)`ï¼‰å°±æ˜¯æˆ‘ä»¬æ³¨å…¥åˆ°JSä¸­çš„æ–¹æ³•ï¼Œåˆ†åˆ«å¯¹åº”çš„åŒæ­¥æ¶ˆæ¯å’Œå¼‚æ­¥æ¶ˆæ¯ï¼Œæˆ‘ä»¬åœ¨Androidä¸­ä½¿ç”¨`webView.addJavascriptInterface(new JavaScriptInterface(this,webView),"android");`å³å¯æ³¨å…¥JSä¸­ï¼Œåœ¨JSä¸­æˆ‘å°±å¯ä»¥ä½¿ç”¨androidå¯¹è±¡è¿›è¡Œè°ƒç”¨äº†ã€‚

### Nativeè°ƒç”¨JS

è‡ªæ­¤ï¼Œé€šè®¯ä¸­JSè°ƒç”¨Nativeéƒ¨åˆ†ï¼Œæˆ‘ä»¬å°±åˆ°è¿™äº†ï¼ŒNativieè°ƒç”¨JSéƒ¨åˆ†å…¶å®æˆ‘ä¸ç”¨åšè¿‡å¤šçš„å¤„ç†ï¼Œåœ¨Androidæˆ‘ä»¬è°ƒç”¨JSä»£ç æœ‰ä¸¤ç§æ–¹å¼ï¼š`loadUrl`å’Œ`evaluateJavascript`ã€‚æ¨èä½¿ç”¨`evaluateJavascript`ï¼Œå®ƒä¸ä»…èƒ½å¤„ç†æ— è¿”å›å€¼ï¼Œè¿˜èƒ½å¤„ç†å¸¦è¿”å›å€¼å‡½æ•°ç±»å‹ã€‚

### ç¼–ç æ–¹æ¡ˆ

åœ¨JSä¸Nativeé€šè®¯æ—¶ï¼Œé€šè®¯åè®®å¯¹è±¡æ˜¯æˆ‘ä»¬ä¸¤ä¸ªç¯å¢ƒé€šè®¯çš„åŸºç¡€æ¡¥æ¢ï¼Œæˆ‘ä»¬å°†åè®®å¯¹è±¡åœ¨ä¸¤ä¸ªç¯å¢ƒä¸‹çš„è½¬æ¢å½¢å¼å®šä¹‰ä¸ºç¼–ç ï¼ˆå³é¢å‘å¯¹è±¡çš„ä¸­çš„åºåˆ—åŒ–æ“ä½œï¼‰ï¼Œå¯¹è±¡æœ¬èº«ç¼–ç çš„æ•ˆç‡å’Œç¨³å®šç›´æ¥å†³å®šäº†è¿™ä¸ªæ¡†æ¶çš„è´¨é‡ã€‚æœ¬æ¡ˆä¾‹ä¸­ä½¿ç”¨jsonä½œä¸ºå¯¹è±¡åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„ä»‹è´¨ï¼Œå…¶ä¼˜åŠ¿åœ¨äºå¯ä»¥åˆ©ç”¨ç°æœ‰çš„ä¸‰æ–¹æ¡†æ¶å¯¹ç¼–ç è¿›è¡Œæ‰˜ç®¡ã€‚

## Cookieç®¡ç†

Cookieä½œä¸ºWebç«¯æœ¬åœ°å‚¨å­˜æ•°æ®çš„é‡è¦æ–¹å¼ä¹‹ä¸€ï¼Œå…¶ä½œç”¨ä¸è¨€è€Œå–»ã€‚åœ¨è®¾è®¡ä¸­Androidå¹³å°ä¸»è¦æ¶‰åŠåˆ°CookieåŒæ­¥çš„é—®é¢˜ï¼Œå…³äºå¦‚ä½•å¤„ç†CookieåŒæ­¥é—®é¢˜è¯·å‚è€ƒã€[CookieåŒæ­¥](https://www.jianshu.com/p/c9a9c4e1756d)ã€‘ã€‚æœ¬æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨Nativeå±‚æä¾›å­˜å‚¨apiçš„æ–¹å¼æ¥ä»£æ›¿Cookieæœºåˆ¶ï¼ŒåŸç†åŒJSè°ƒç”¨Nativeä¸€æ ·ã€‚

## å‚è€ƒ

- [Androidæ··åˆH5è¿›è¡ŒHybridå¼€å‘çš„æ¢ç´¢](https://zhuanlan.zhihu.com/p/22186151?refer=c_46929389)
- [Hybrid APPæ¶æ„è®¾è®¡æ€è·¯](https://github.com/chemdemo/chemdemo.github.io/issues/12)
- [ä»é›¶æ”¶æ‹¾ä¸€ä¸ªhybridæ¡†æ¶ï¼ˆä¸€ï¼‰-- ä»é€‰æ‹©JSé€šä¿¡æ–¹æ¡ˆå¼€å§‹](http://awhisper.github.io/2018/01/02/hybrid-jscomunication/)
- [ä»é›¶æ”¶æ‹¾ä¸€ä¸ªhybridæ¡†æ¶ï¼ˆäºŒï¼‰-- WebViewå®¹å™¨åŸºç¡€åŠŸèƒ½è®¾è®¡æ€è·¯](http://awhisper.github.io/2018/03/06/hybrid-webcontainer/)
- [Androidï¼šä½ è¦çš„WebViewä¸JSäº¤äº’æ–¹å¼éƒ½åœ¨è¿™é‡Œäº†](https://blog.csdn.net/carson_ho/article/details/64904691)
- [Android æ§ä»¶WebViewè®¾ç½®Cookie](https://www.jianshu.com/p/c9a9c4e1756d)